!function(global){var regData={pmr:null,appId:null,apikey:null,pt:"standard",vid:null,subtkn:null,subauth:null,subp256:null,ts:null,appver:null,ver:2.1,uagnt:null,sw:null,sh:null,sdensity:null,lat:null,lon:null,accuracy:null,locale:null,tz:null,lp:null,tojson:function(){return{pmr:this.pmr,appId:this.appId,apikey:this.apikey,pt:"standard",vid:this.vid,subtkn:this.subtkn,subauth:this.subauth,subp256:this.subp256,ts:this.ts,appver:this.appver,ver:"1.0",uagnt:this.uagnt,sw:this.sw,sh:this.sh,sdensity:this.sdensity,lat:this.lat,lon:this.lon,accuracy:this.accuracy,locale:this.locale,tz:this.tz,edti:this.edti,usrid:this.usrid,lp:this.lp}}},logger={level:"error",error:function(t){("error"==this.level||"info"==this.level||"debug"==this.level)&&console.error(t)},info:function(t){("info"==this.level||"debug"==this.level)&&console.info(t)},debug:function(t){"debug"==this.level&&console.log(t)}},STORE_CONST={SUBSCRIPTION:"subscription",VISITORID:"visitorId",REGDATA:"regData",WEB_PUSH_CONFIG_DATA:"WPushconfigData",LAST_REG_SENT:"lastRegSent",NOTIFICATION_PMR:"NP",REG_FLAG:"RegSent",LAT:"lat",LON:"lon",ACC:"accuracy",USER_ID:"userId",EDTI:"edti",LOCAL_STORAGE:"LS",DB_STORAGE:"DB",ANALYTICS:"Analytics",EI:"ei",EI_CONTEXT:"eiContext",LP:"lp",RESEND_REG:"resendReg",APP_VERSION:"appVer",DOP_LAST_TIME_PPS_SHOWN:"PPS_TIME",DOP_VISIT_COUNT:"lastVisitCnt",DOP_NXT_STEP:"DOP_NXT_STEP",DOP_DISP_NXT_VIST:"DOP_DISP_NXT_VIST",DOP_BR_LIST:"DOP_BR_LIST"},utilFunc={hasBrowserVerSupportPush:function(){var t=!0;return"serviceWorker"in navigator||(t=!1,logger.error("No Service Worker support!")),"PushManager"in window||(t=!1,logger.error("No Push API Support!")),"Notification"in window||(t=!1,logger.error("No Notification API Support!")),t},generateUUID:function(){window.crypto,window.crypto.getRandomValues;var t=function(e,n,r){return e.length>=n?e:t(r+e,n,r||" ")},e=function(e){return t(e.toString(16),4,"0")},n=new window.Uint16Array(8);return window.crypto.getRandomValues(n),[e(n[0])+e(n[1]),e(n[2]),e(n[3]),e(n[4]),e(n[5])+e(n[6])+e(n[7])].join("-")},getBrowserType:function(){if(navigator.userAgent.search("MSIE")>=0)return"MSIE";if(navigator.userAgent.search("Chrome")>=0)return"Chrome";if(navigator.userAgent.search("Firefox")>=0)return"Firefox";if(navigator.userAgent.search("Safari")>=0&&0>navigator.userAgent.search("Chrome"))return"Safari";if(navigator.userAgent.search("Opera")>=0)return"Opera"},getBrowserVersion:function(){var t=-1;return/Chrome\/([0-9]+)\./.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor)&&!/OPR\/([0-9]+)\./.test(navigator.userAgent)?t=navigator.userAgent.match(/Chrome\/([0-9]+)\./)[1]:/Firefox\/([0-9]+)\./.test(navigator.userAgent)?t=navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:/OPR\/([0-9]+)\./.test(navigator.userAgent)&&(t=navigator.userAgent.match(/OPR\/([0-9]+)\./)[1]),t},toJSONString:function(t){var e=null;if(t)try{e=JSON.stringify(t)}catch(n){}return e},toJSONObj:function(t){var e=null;if(t)try{e=JSON.parse(t)}catch(n){logger.error("unable to parse JSON String"+t)}return e},isValidObject:function(t){return t||null},isPromise:function(t){try{if("function"==typeof t.then)return!0}catch(e){logger.error("Exception in isPromise:: "+e)}return!1},distance:function(t,e,n,r){var s=(n-t)*Math.PI/180,o=(r-e)*Math.PI/180,a=Math.sin(s/2)*Math.sin(s/2)+Math.cos(t*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(o/2)*Math.sin(o/2);return Math.round(1e3*(6371*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)))))}},repository={storeData:function(t,e,n=STORE_CONST.LOCAL_STORAGE){let r=webPushManager.getAPIKey();n==STORE_CONST.DB_STORAGE?(this.dbStore.initDB(r),this.dbStore.storeDBData(t,e)):n==STORE_CONST.LOCAL_STORAGE&&(this.sessionStore.init(r),this.sessionStore.storeData(t,e))},getStoreData:function(t,e=STORE_CONST.LOCAL_STORAGE){let n=webPushManager.getAPIKey();return e==STORE_CONST.DB_STORAGE?(this.dbStore.initDB(n),this.dbStore.getDBData(t)):e==STORE_CONST.LOCAL_STORAGE?(this.sessionStore.init(n),this.sessionStore.getStoreData(t)):void 0},removeStoreData:function(t,e=STORE_CONST.LOCAL_STORAGE){let n=webPushManager.getAPIKey();return e==STORE_CONST.DB_STORAGE?(this.dbStore.initDB(n),this.dbStore.removeDBData(t)):e==STORE_CONST.LOCAL_STORAGE?(this.sessionStore.init(n),this.sessionStore.removeData(t)):void 0},clear:function(t=STORE_CONST.LOCAL_STORAGE){let e=webPushManager.getAPIKey();t==STORE_CONST.DB_STORAGE?(this.dbStore.initDB(e),this.dbStore.removeAllDBData()):t==STORE_CONST.LOCAL_STORAGE&&(this.sessionStore.init(e),this.sessionStore.removeAllData())},dbStore:{db:null,prefix:null,initDB:function(t){return this.db||(this.prefix=t,this.db=new Promise(function(e,n){var r=window.indexedDB.open("wpDatabase",1);r.addEventListener("upgradeneeded",function(e){e.target.result.createObjectStore(t+"_rsysWPData",{keyPath:"type"})}),r.addEventListener("success",function(t){return e(r.result)}),r.addEventListener("error",function(t){return n(t)})})),this.db},getObjectStore:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=e?"readwrite":"readonly";return t.transaction([repository.dbStore.prefix+"_rsysWPData"],n).objectStore(repository.dbStore.prefix+"_rsysWPData")},requestToPromise:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(t){return t.target.result},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(t){return t.target.error};return new Promise(function(r,s){t.addEventListener("success",function(t){return r(e(t))}),t.addEventListener("error",function(t){return s(n(t))})})},storeDBData:function(t,e){let n=webPushManager.getAPIKey();try{return this.initDB(n).then(function(n){return repository.dbStore.requestToPromise(repository.dbStore.getObjectStore(n,!0).put({type:t,value:e}))})}catch(r){logger.error(r)}},getDBData:function(t){let e=webPushManager.getAPIKey();try{return data=this.initDB(e).then(function(e){return repository.dbStore.requestToPromise(repository.dbStore.getObjectStore(e).get(t),function(t){if(void 0!==t.target.result)return t.target.result.value})})}catch(n){logger.error(n)}},removeDBData:function(t){let e=webPushManager.getAPIKey();try{return data=this.initDB(e).then(function(e){return repository.dbStore.requestToPromise(repository.dbStore.getObjectStore(e,!0).delete(t),function(t){if(void 0!==t.target.result)return t.target.result.value})})}catch(n){logger.error(n)}},removeAllDBData:function(){let t=webPushManager.getAPIKey();this.initDB(t).then(function(t){return repository.dbStore.requestToPromise(repository.dbStore.getObjectStore(t,!0).clear(),function(t){if(void 0!==t.target.result)return t.target.result.value})})}},sessionStore:{nameSpace:null,lsSupport:window.localStorage,init:function(t){this.nameSpace=t+"_"},storeData:function(t,e){this.lsSupport.setItem(this.nameSpace+t,e)},getStoreData:function(t){return this.lsSupport.getItem(this.nameSpace+t)},removeData:function(t){return this.lsSupport.removeItem(this.nameSpace+t)},removeAllData:function(){this.lsSupport.clear()}}},webPushManager={configData:null,swLocation:"/webpush-service-worker.js",permission:null,subscription:null,dirtyChk:!1,logLevel:"info",latPos:null,longPos:null,acc:null,geoPermStatus:"X",isSwAlreadyRegistered:!1,doCleanUp:!1,isUsrIdUpdated:!1,locUsrid:null,isEdtiUpdated:!1,locEdtiId:null,eiContext:{},CONVERSION_PARAMS:{TYPE:null,ORDERID:null,ORDERTOTAL:null,NUMITEMS:null,CUSTOMERID:null},LOG_LEVEL:{DEBUG:"debug",INFO:"info",ERROR:"error"},swScope:"/",locPref:null,isPrefUpdated:null,setLogLevel:function(t){t&&(""!=t.trim()||"debug"===t||"info"===t||"error"===t)&&(logger.level=t)},validateConfigObject:async function(){if(!(this.configData&&this.configData.appserviceKey&&this.configData.apiKey&&this.configData.accountToken&&this.configData.apiHost))throw Error('Invalid configuration object it should contain following mandatatory attributes {"appserviceKey": "","apiKey":"XXXXXXXX", "accountToken": "XXXXXXXXXXX", "apiHost": "TXxZuQJcnLVJ.com"}')},setEdti:function(t){!webPushManager.isNotificationPermNotRequested()&&this.getSubscription()&&(this.isEdtiUpdated=!0,this.locEdtiId=t,this.dirtyChk=!0,this.dirty())},resetEdti:function(){this.setEdti("")},getEdti:function(){let t=this.getBaseRequestPath()+"/edti?vi="+this.getVisitorId();return this.getRemoteData(t)},setUserId:function(t){!webPushManager.isNotificationPermNotRequested()&&this.getSubscription()&&(this.locUsrid=t,this.isUsrIdUpdated=!0,this.dirtyChk=!0,this.dirty())},resetUserId:function(){this.setUserId("")},setNotificationPreference:function(t){if(!webPushManager.isNotificationPermNotRequested()&&this.getSubscription()){if(null!=t&&(null==(prefObj=utilFunc.toJSONObj(t))||"object"!=typeof prefObj))throw logger.error("Invalid Preference JSON object"),"Invalid Notification Preference JSON object";this.locPref=t,this.isPrefUpdated=!0,this.dirtyChk=!0,this.dirty()}},getUserId:function(){let t=this.getBaseRequestPath()+"/userid?vi="+this.getVisitorId();return this.getRemoteData(t)},setAppversion:function(t){t&&null!=t&&""!=t&&(this.storeData(STORE_CONST.APP_VERSION,t),(cd=this.getConfigData())&&"string"!=typeof cd&&"object"==typeof cd&&"string"==typeof t&&t!=cd.appver&&(logger.debug("updating app version and sending registration"),cd.appver=t,this.setConfigData(cd),this.dirtyChk=!0,this.dirty()))},enableAnalytics:function(t){if("boolean"==typeof t)this.storeData(STORE_CONST.ANALYTICS,t),this.storeData(STORE_CONST.ANALYTICS,t,STORE_CONST.DB_STORAGE),t||this.resetEngagementContext();else throw Error("Flag value should be true/false")},isAnalyticsEnabled:function(){let t=this.getStoreData(STORE_CONST.ANALYTICS);return void 0===t||null==t||"true"==t||!0==t},getEngagementContext:async function(){return this.isAnalyticsEnabled()?await this.getStoreData(STORE_CONST.EI_CONTEXT,STORE_CONST.DB_STORAGE).then(t=>void 0===t?null:t).catch(t=>({})):null},resetEngagementContext:function(){try{this.removeStoreData(STORE_CONST.EI,STORE_CONST.DB_STORAGE),this.removeStoreData(STORE_CONST.EI_CONTEXT,STORE_CONST.DB_STORAGE)}catch(t){logger.error("Error while resetEngagementContext "+error)}},raiseConversionEvent:function(t,e=null,n=!1){this.isAnalyticsEnabled()?this.getEngagementContext().then(r=>{if(r&&null!=r&&Object.keys(r).length>0&&null!=r.ei){let s=webPushManagerAPI.CONVERSION_TYPE[t];void 0===s&&(s=webPushManagerAPI.CONVERSION_TYPE.OTHERS),(paramsToSend={ei:null,type:null,orderId:null,orderTotal:null,numItems:null,customerId:null}).type=s,paramsToSend.ei=r.ei,paramsToSend.uagnt=self.navigator.userAgent,void 0===e||null==e||0==Object.keys(e).length||e.TYPE!=webPushManagerAPI.CONVERSION_TYPE.PURCHASE||(paramsToSend.orderId=e.ORDERID,paramsToSend.orderTotal=e.ORDERTOTAL,paramsToSend.numItems=e.NUMITEMS,paramsToSend.customerId=e.CUSTOMERID),webPushManager.sendRequest(this.getBaseRequestPath()+"/event/conversion",utilFunc.toJSONString(paramsToSend)).then(t=>{t&&n&&webPushManager.resetEngagementContext()})}else logger.debug("Can not raise Conversion Event due to no ei available")}).catch(t=>{logger.error("Unable to find Engagement context hence not raising conversion event")}):logger.debug("Suppressing Events due to user disabled analytics")},raisePurchaseEvent:function(t,e=!1){if(void 0===t||null==t||0==Object.keys(t).length)throw Error("Invalid conversionParams Object, It should contain {TYPE:'PURCHASE', ORDERID: <ORDER_ID>, ORDERTOTAL: <ORDER_TOTAL_VALUE>}");if(t.TYPE==webPushManagerAPI.CONVERSION_TYPE.PURCHASE&&null!=t.ORDERID&&null!=t.ORDERTOTAL)this.raiseConversionEvent(webPushManagerAPI.CONVERSION_TYPE.PURCHASE,t,e);else throw Error("Invalid Purchase Event Parameters, It should contain {TYPE:'PURCHASE', ORDERID: <ORDER_ID>, ORDERTOTAL: <ORDER_TOTAL_VALUE>}")},validate:function(){return this.validateConfigObject().then().catch(t=>{logger.error(t)}),!!utilFunc.hasBrowserVerSupportPush()},serviceWorkerLocation:async function(){let t=this.getConfigData();return t&&t.swLoc&&(this.swLocation=t.swLoc),this.swLocation},serviceWorkerScope:function(){let t=this.getConfigData();if(t&&t.swScope)this.swScope=t.swScope;else if(t&&t.swLoc){let e=t.swLoc,n=e.lastIndexOf("/");this.swScope=e.substr(0,n),""===this.swScope?this.swScope="/":this.swScope.length>1&&!this.swScope.endsWith("/")&&(this.swScope=this.swScope.concat("/"))}return logger.debug("***SwLoc:"+this.swScope),this.swScope},initialized:function(){return!!this.configData},initRegData:function(){var t=this.getRegJsonObj();t&&null!=t&&(regData=t)},getRegJsonObj:function(){var t=this.getStoreData(STORE_CONST.REGDATA);if(t){logger.debug("Found Registration Data at client storage");try{if(regData=t,"string"==typeof t){var e=utilFunc.toJSONObj(t);return regData=e,e}}catch(n){logger.error("Error while parsing persistedRegData")}}return null},init:function(t){if(this.initialized())return;this.configData=utilFunc.toJSONObj(t);let e=utilFunc.toJSONObj(this.getStoreData(STORE_CONST.WEB_PUSH_CONFIG_DATA));if(e&&null!=e&&this.configData&&null!=this.configData){let n=this.getStoreData(STORE_CONST.APP_VERSION);n&&null!=n&&""!=n&&(this.configData.appver=n),(e.appserviceKey!=this.configData.appserviceKey||e.apiKey!=this.configData.apiKey||e.accountToken!=this.configData.accountToken||e.apiHost!=this.configData.apiHost)&&(this.dirtyChk=!0)}document.getElementById("dopContainer")&&(this.configData.lazy=!0),this.setConfigData(this.configData),this.initRegData(),logger.debug("lazy::"+this.configData.lazy),logger.debug("this.configData:: "+utilFunc.toJSONString(this.configData)),this.removeStoreData(STORE_CONST.USER_ID),this.removeStoreData(STORE_CONST.EDTI),this.removeStoreData(STORE_CONST.USER_ID,STORE_CONST.DB_STORAGE),this.removeStoreData(STORE_CONST.EDTI,STORE_CONST.DB_STORAGE);var r=this.getRegJsonObj();if(r){delete r.usrid,delete r.edti;let s=utilFunc.toJSONString(r);s=this.removeSensitiveDataFrmReg(s),this.persistRegStrData(s)}this.configData.lazy?this.isSWRegistered().then(t=>{t&&!webPushManager.isNotificationPermNotRequested()&&this.getSubscription()&&webPushManager.register()}):this.register()},dirty:function(){if(!this.getSubscription())return;var t=this.getStoreData(STORE_CONST.LAST_REG_SENT);t||(t=new Date().getTime());var e=new Date().getTime(),n=(e-t)/864e5,r=this.getStoreData(STORE_CONST.NOTIFICATION_PMR);logger.debug("currTime::"+e),logger.debug("lastRegSentTime::"+t),r&&r!=this.getNotificationPermission()&&(logger.debug("persistedPmr::"+r),logger.debug("getNotificationPermission::"+this.getNotificationPermission()),"denied"===r&&"granted"===this.getNotificationPermission()?this.generateVistorId(!0):"granted"===r&&"denied"===this.getNotificationPermission()&&(this.doCleanUp=!0),this.dirtyChk=!0);let s=repository.getStoreData(STORE_CONST.RESEND_REG);!this.dirtyChk&&s&&(!0==s||"true"==s)&&(this.dirtyChk=!0),this.isRegistrationDataChanged(),logger.debug("timeDiff:: "+n),logger.debug("dirtyChk:: "+this.dirtyChk),(this.dirtyChk||n>1)&&this.triggerReg()},triggerReg:function(){this.isSwAlreadyRegistered?this.populateAndSendReg():this.registerServiceWorker()},isRegistrationDataChanged:function(){let t=this.getRegJsonObj(),e=this.getConfigData();this.dirtyChk||null==t||t.pmr==this.getOptInOptOutStatus()&&t.appId==e.appId&&t.apikey==e.apiKey&&t.vid==this.getVisitorId()&&t.appver==e.appver&&t.uagnt==navigator.userAgent&&t.sw==screen.width&&t.sh==screen.height&&t.sdensity==window.devicePixelRatio&&t.locale==navigator.language&&t.tz==Intl.DateTimeFormat().resolvedOptions().timeZone&&"standard"==t.pt||this.triggerReg()},geoLocationChanged:function(){repository.getStoreData(STORE_CONST.LP);let t=repository.getStoreData(STORE_CONST.LAT),e=repository.getStoreData(STORE_CONST.LON);navigator.geolocation.getCurrentPosition(n=>{let r=n.coords.latitude,s=n.coords.longitude,o=n.coords.accuracy;(repository.storeData(STORE_CONST.LP,"A"),t&&e&&null!=t&&null!=e&&"null"!=t&&"null"!=e)?t&&e&&r&&s&&utilFunc.distance(t,e,r,s)>500&&(logger.debug("Geo Location Changed morethan 500 mtr, Hence Raising Registration"),webPushManager.dirtyChk||webPushManager.triggerReg()):(repository.storeData(STORE_CONST.LAT,r),repository.storeData(STORE_CONST.LON,s),repository.storeData(STORE_CONST.ACC,o),this.triggerReg())})},getConfigData:function(){if(!this.initialized()){var t=this.getStoreData(STORE_CONST.WEB_PUSH_CONFIG_DATA);t&&(this.configData=utilFunc.toJSONObj(t))}return this.configData},setConfigData:function(t){this.storeData(STORE_CONST.WEB_PUSH_CONFIG_DATA,utilFunc.toJSONString(t))},register:async function(){await this.isSWRegistered(),this.validate()&&(this.setConfigData(this.getConfigData()),this.dirty(),logger.debug("calling register function"),this.registerServiceWorker())},requestNotificationPermission:async function(){return await window.Notification.requestPermission()},isWebSiteRegistered:function(){return!!this.getStoreData(STORE_CONST.REG_FLAG)},getNotificationPermission:function(){return Notification.permission},isNotificationPermGranted:function(){return"granted"===this.getNotificationPermission()},isNotificationPermDenied:function(){return"denied"===this.getNotificationPermission()},isNotificationPermNotRequested:function(){return"default"===this.getNotificationPermission()},getOptInOptOutStatus:function(){return this.isNotificationPermGranted()?"I":(this.isNotificationPermDenied(),"O")},isSWRegistered:async function(){var t=await webPushManager.serviceWorkerLocation().then(t=>t).catch(t=>webPushManager.swLocation);return await navigator.serviceWorker.getRegistrations().then(e=>{try{var n=!1;if(e.length>0){for(i=0;i<e.length;i++)if(-1!=e[i].active.scriptURL.indexOf(t)){webPushManager.isSwAlreadyRegistered=!0,n=!0;break}}}catch(r){logger.error("Error while getting existing registrations")}return n})},unregisterServiceWorker:async function(){"serviceWorker"in navigator&&navigator.serviceWorker.getRegistrations().then(function(t){if(t.length>0){for(i=0;i<t.length;i++)if(t[i].scope.indexOf(window.location.origin)>-1){t[i].pushManager.getSubscription().then(t=>{t&&t.unsubscribe()}).catch(t=>{logger.error("Error while unsbscribing"+t.message)}),t[i].unregister();break}}}).catch(t=>{logger.error("Error while unregister service worker"+t.message)})},registerServiceWorker:async function(){if(this.isNotificationPermNotRequested()||this.isNotificationPermGranted()){var t=!1;-1!=navigator.userAgent.indexOf("Safari")&&(t=!0),t||await this.requestNotificationPermission(),(this.isNotificationPermGranted()||t)&&await this.serviceWorkerLocation().then(t=>{navigator.serviceWorker.register(t,{scope:webPushManager.serviceWorkerScope()}).then(function(t){var e;logger.debug("Registering Service Worker"),t.installing?e=t.installing:t.waiting?e=t.waiting:t.active&&(e=t.active),e&&("activated"==e.state&&webPushManager.subscribeUser(t),e.addEventListener("statechange",function(e){"activated"==e.target.state&&webPushManager.subscribeUser(t)}))}).catch(t=>{logger.error(t.message)})}).catch(t=>{logger.error(t.message)})}},checkSubscriptionAndSendRegistration:function(t){var e=this.getSubscription();this.subscriptionChanged(t,e)},subscriptionChanged:function(t,e){var n=utilFunc.toJSONString(t);logger.debug("persistedSubscription::"+e),logger.debug("subscription::"+n),(this.dirtyChk||e!=n)&&(logger.debug("Subscription Token changed Hence raising Registration Event"),this.setSubscription(t),this.populateAndSendReg())},setSubscription:function(t){var e=utilFunc.toJSONString(t);this.subscription=e,this.storeData(STORE_CONST.SUBSCRIPTION,e),this.storeData(STORE_CONST.SUBSCRIPTION,e,STORE_CONST.DB_STORAGE)},getSubscription:function(){return this.subscription?this.subscription:this.getStoreData(STORE_CONST.SUBSCRIPTION)},storeData:function(t,e,n=STORE_CONST.LOCAL_STORAGE){return repository.storeData(t,e,n)},getStoreData:function(t,e=STORE_CONST.LOCAL_STORAGE){return repository.getStoreData(t,e)},removeStoreData:function(t,e=STORE_CONST.LOCAL_STORAGE){return repository.removeStoreData(t,e)},unRegister:function(){var t=this.getStoreData(STORE_CONST.REGDATA);try{t&&(this.sendRequest(this.getBaseRequestPath()+"/dereg",t),this.cleanUp())}catch(e){logger.error("Error in unRegister")}},cleanUp:function(){try{repository.clear(STORE_CONST.LOCAL_STORAGE),repository.clear(STORE_CONST.DB_STORAGE),this.unregisterServiceWorker()}catch(t){logger.error("Error in unRegister")}},getVisitorId:function(){return this.generateVistorId(!1)},generateVistorId:function(t){var e=this.getStoreData(STORE_CONST.VISITORID);return(t||!e)&&(e=utilFunc.generateUUID(),repository.storeData(STORE_CONST.VISITORID,e),repository.storeData(STORE_CONST.VISITORID,e,STORE_CONST.DB_STORAGE)),e},getAPIKey:function(){var t=this.getConfigData();return t?t.apiKey:null},getSubscriptionEndPoint:function(){var t=this.getSubscription();return t?utilFunc.toJSONObj(t).endpoint:null},getSubscriptionAuth:function(){var t=this.getSubscription();return t?utilFunc.toJSONObj(t).keys.auth:null},getSubscriptionP256:function(){var t=this.getSubscription();return t?utilFunc.toJSONObj(t).keys.p256dh:null},validateAndStorRegData:function(t){t&&(t=this.removeSensitiveDataFrmReg(t),this.persistRegStrData(t))},persistRegStrData:function(t){repository.storeData(STORE_CONST.REGDATA,t),repository.storeData(STORE_CONST.REGDATA,t,STORE_CONST.DB_STORAGE)},removeSensitiveDataFrmReg:function(t){if(t&&"string"==typeof t){let e=utilFunc.toJSONObj(t);delete e.usrid,delete e.edti,t=utilFunc.toJSONString(e)}return t},getGeoPermissionStatus:async function(){if(webPushManager.geoPermStatus="X",navigator.geolocation){if(webPushManager.geoPermStatus="U",navigator.permissions){var t=await navigator.permissions.query({name:"geolocation"});logger.debug("Geo Permission status"+t.state),"granted"==t.state?navigator.geolocation.getCurrentPosition(webPushManager.getGeoPosition,webPushManager.getGeoPermError):"denied"===t.state&&(webPushManager.geoPermStatus="D",regData.lat=null,regData.lon=null,regData.accuracy=null)}else navigator.geolocation.getCurrentPosition(webPushManager.getGeoPosition,webPushManager.getGeoPermError)}},getGeoPosition:async function(t){t&&(webPushManager.geoPermStatus="A",webPushManager.latPos=t.coords.latitude,webPushManager.longPos=t.coords.longitude,webPushManager.acc=t.coords.accuracy)},storeGeoLocation:function(){repository.storeData(STORE_CONST.LAT,regData.lat),repository.storeData(STORE_CONST.LON,regData.lon),repository.storeData(STORE_CONST.ACC,regData.accuracy),repository.storeData(STORE_CONST.LP,regData.lp)},getGeoPermError:async function(t){if(t)switch(t.code){case t.PERMISSION_DENIED:webPushManager.geoPermStatus="D";break;case t.POSITION_UNAVAILABLE:case t.PERMISSION_DENIED_TIMEOUT:webPushManager.geoPermStatus="E"}regData.lat=null,regData.lon=null,regData.accuracy=null},populateRegData:async function(){var t=this.getConfigData();if(!t)throw Error("WebPush SDK not initialized");regData.pmr=this.getOptInOptOutStatus(),regData.appId=t.appId,regData.apikey=t.apiKey,regData.vid=this.getVisitorId(),regData.subtkn=this.getSubscriptionEndPoint(),regData.subauth=this.getSubscriptionAuth(),regData.subp256=this.getSubscriptionP256(),regData.ts=new Date().getTime(),regData.appver=t.appver,regData.ver="1.0.3",regData.pt="standard",regData.uagnt=navigator.userAgent,regData.sw=screen.width,regData.sh=screen.height,regData.sdensity=window.devicePixelRatio,regData.lp=null,regData.lat=null,webPushManager.latPos,regData.lon=null,webPushManager.longPos,regData.accuracy=null,webPushManager.acc,regData.locale=navigator.language,regData.tz=Intl.DateTimeFormat().resolvedOptions().timeZone,this.storeGeoLocation()},urlB64ToUint8Array:function(t){let e="=".repeat((4-t.length%4)%4),n=(t+e).replace(/\-/g,"+").replace(/_/g,"/"),r=atob(n),s=new Uint8Array(r.length);for(let o=0;o<r.length;o++)s[o]=r.charCodeAt(o);return s},getRegistrationEndPoint:function(){return this.getBaseRequestPath()+"/reg"},populateAndSendReg:async function(){await this.populateRegData(),this.isUsrIdUpdated&&(regData.usrid=this.locUsrid),this.isEdtiUpdated&&(regData.edti=this.locEdtiId),this.isPrefUpdated&&(regData.npref=this.locPref);let t=regData;"string"!=typeof regData&&(t=utilFunc.toJSONString(regData)),this.sendRegistration(this.getRegistrationEndPoint(),t),repository.storeData(STORE_CONST.NOTIFICATION_PMR,Notification.permission)},subscribeUser:function(t){logger.debug("subscribing user");let e=this.urlB64ToUint8Array(this.getConfigData().appserviceKey),n={applicationServerKey:e,userVisibleOnly:!0};t.pushManager.subscribe(n).then(function(t){logger.debug("Subscription Object"+utilFunc.toJSONString(t)),webPushManager.checkSubscriptionAndSendRegistration(t)}).catch(function(t){logger.error(t.message)})},getApiHost:function(){let t=this.getConfigData(),e=null;return(e=t&&t.apiHost?t.apiHost:(jsonConfig=utilFunc.toJSONObj(t)).apiHost)&&e.endsWith("/")&&(e=e.substring(0,e.length-1)),e},getBaseRequestPath:function(){let t=this.getConfigData();var e="",n="";t&&t.accountToken?(e=t.accountToken,n=t.apiKey):(e=(jsonConfig=utilFunc.toJSONObj(t)).accountToken,n=jsonConfig.apiKey);let r=this.getApiHost();return r&&r.endsWith("/")&&(r=r.substring(0,r.length-1)),r+"/webpushlistener/wpl/v3/signal/"+e+"/"+n},sendRegistration:async function(t,e){this.validateAndStorRegData(e);var n=null;return this.sendRequest(t,e).then(t=>{t?(repository.storeData(STORE_CONST.LAST_REG_SENT,new Date().getTime()),repository.storeData(STORE_CONST.REG_FLAG,!0),repository.storeData(STORE_CONST.RESEND_REG,!1),this.isUsrIdUpdated&&(this.isUsrIdUpdated=!1),this.isEdtiUpdated&&(this.isEdtiUpdated=!1)):repository.storeData(STORE_CONST.RESEND_REG,!0),webPushManager.doCleanUp&&webPushManager.cleanUp(),webPushManager.dirtyChk=!1,webPushManager.doCleanUp=!1}).catch(t=>{logger.error("Error while sending Registration")}),n},sendRequest:async function(t,e){if(!e)return;let n=!1,r=t;logger.debug("Data is sending to ::"+r);try{await fetch(r,{method:"post",mode:"no-cors",headers:{"Content-Type":"application/json"},body:e}),n=!0}catch(s){n=!1}return this.dirtyChk=!1,n},getRemoteData:function(t){try{var e=new XMLHttpRequest;return e.open("GET",t,!1),e.send(null),e.responseText}catch(n){console.log("Error fetching data"+t,n)}return null},updatedoubleOptInStats:function(){this.storeData(STORE_CONST.DOP_LAST_TIME_PPS_SHOWN,new Date().getTime());var lastVisitCnt=this.getStoreData(STORE_CONST.DOP_VISIT_COUNT),nextSkipStep=this.getStoreData(STORE_CONST.DOP_NXT_STEP),displayInNextVist=this.getStoreData(STORE_CONST.DOP_DISP_NXT_VIST);lastVisitCnt||(lastVisitCnt=0),nextSkipStep||(nextSkipStep=0),displayInNextVist||(displayInNextVist=0),parseInt(lastVisitCnt)==parseInt(displayInNextVist)&&(displayInNextVist=eval(parseInt(lastVisitCnt)+parseInt(nextSkipStep)+1),nextSkipStep=eval(parseInt(nextSkipStep)+1)),this.storeData(STORE_CONST.DOP_NXT_STEP,nextSkipStep),this.storeData(STORE_CONST.DOP_DISP_NXT_VIST,displayInNextVist)},showDoubleOptInPrompt:function(){if(this.showDOPForBrowser()){var t=this.getStoreData(STORE_CONST.DOP_LAST_TIME_PPS_SHOWN),e=this.getStoreData(STORE_CONST.DOP_VISIT_COUNT);if(e||(e=0),!t)return this.storeData(STORE_CONST.DOP_VISIT_COUNT,e),!0;var n=this.getStoreData(STORE_CONST.DOP_DISP_NXT_VIST),r=this.getStoreData(STORE_CONST.DOP_NXT_STEP);if(this.ppsShownOneDayAgo()&&(e=parseInt(e)+1,this.storeData(STORE_CONST.DOP_VISIT_COUNT,e)),"default"===this.getNotificationPermission()&&this.ppsShownOneDayAgo()&&e==n&&r<=this.getMaxDisplayTimes())return this.storeData(STORE_CONST.DOP_LAST_TIME_PPS_SHOWN,new Date().getTime()),!0;this.storeData(STORE_CONST.DOP_LAST_TIME_PPS_SHOWN,new Date().getTime())}return!1},getMaxDisplayTimes:function(){return 5},ppsShownOneDayAgo:function(){var t;return(new Date().getTime()-this.getStoreData(STORE_CONST.DOP_LAST_TIME_PPS_SHOWN))/864e5>1},showDOPForBrowser:function(){let t=navigator.userAgent,e=this.getStoreData(STORE_CONST.DOP_BR_LIST).split(",");if(e.length>0)return!!(e.includes("OP")&&e.includes("Chrome")&&t.indexOf("OP")>-1)||e.filter(e=>t.indexOf(e)>-1).length>0;return!1},registerDOPForBrowsers:function(...t){return t.length>0&&(this.storeData(STORE_CONST.DOP_BR_LIST,t),!0)}},webPushManagerAPI={CONVERSION_TYPE:{PURCHASE:"PURCHASE",OTHERS:"OTHERS"},init:function(t){webPushManager.init(t)},setEdti:function(t){webPushManager.setEdti(t)},resetEdti:function(){webPushManager.resetEdti()},getEdti:function(){return webPushManager.getEdti()},setUserId:function(t){webPushManager.setUserId(t)},resetUserId:function(){webPushManager.resetUserId()},setNotificationPreference:function(t){webPushManager.setNotificationPreference(t)},getUserId:function(){return webPushManager.getUserId()},setAppversion:function(t){webPushManager.setAppversion(t)},enableAnalytics:function(t){webPushManager.enableAnalytics(t)},isAnalyticsEnabled:function(){return webPushManager.isAnalyticsEnabled()},getEngagementContext:function(){return webPushManager.getEngagementContext()},resetEngagementContext:function(){webPushManager.resetEngagementContext()},raiseConversionEvent:function(t,e=null,n=!1){webPushManager.raiseConversionEvent(t,e,n)},raisePurchaseEvent:function(t,e=!1){webPushManager.raisePurchaseEvent(t,e)},register:function(){webPushManager.register()},getNotificationPermission:function(){return webPushManager.getNotificationPermission()},getOptInOptOutStatus:function(){return webPushManager.getOptInOptOutStatus()},unRegister:function(){webPushManager.unRegister()},getVisitorId:function(){return webPushManager.getVisitorId()},getStoreData:function(t,e=STORE_CONST.LOCAL_STORAGE){return webPushManager.getStoreData(t,e)},getAPIKey:function(){return webPushManager.getAPIKey()},setLogDebugLevel:function(){webPushManager.setLogLevel(webPushManager.LOG_LEVEL.DEBUG)},setLogInfoLevel:function(){webPushManager.setLogLevel(webPushManager.LOG_LEVEL.INFO)},setLogERRORLevel:function(){webPushManager.setLogLevel(webPushManager.LOG_LEVEL.ERROR)},showDoubleOptInPrompt:function(){return webPushManager.showDoubleOptInPrompt()},updatedoubleOptInStats:function(){return webPushManager.updatedoubleOptInStats()},registerBrowsers:function(...t){return webPushManager.registerDOPForBrowsers(t)}};if(global.webPushManager)throw Error("WebPushManager has already been defined");global.webPushManagerAPI=webPushManagerAPI}(window),function(){let t=document.getElementById("rsyswpsdk").getAttribute("wpconfig");webPushManagerAPI.init(t)}();